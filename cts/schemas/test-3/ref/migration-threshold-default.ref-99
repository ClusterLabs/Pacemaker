<cib crm_feature_set="3.19.7" validate-with="pacemaker-4.0" epoch="8" num_updates="0" admin_epoch="0">
  <configuration>
    <!-- The essential elements of this test are:
         * There are the following resources:
           * A template
           * A primitive outside of any collective resource
           * A group containing a single member
           * A cloned primitive
           * A cloned group containing a single member
           * A bundle containing a primitive
         * There is a rsc_defaults element.
         * Each resource (including nested resources) and the rsc_defaults
           element have a meta_attributes element containing at least an nvpair
           with name="migration-threshold" and value="default".
         * Most meta_attributes blocks have rules, but a few do not (called out
           in comments).
         * There are nvpairs with name="migration-threshold" and value="default"
           in cluster_property_set, instance_attributes, and utilization blocks.
         * There is an nvpair with name="migration-threshold" and
           value="default" in a meta_attributes block within an op element.
         * There is one meta_attributes nvpair with name="some-option" and
           value="default".

         In this situation:
         * All "migration-threshold" nvpairs with value "default" in a resource
           or rsc_defaults meta_attributes block should be dropped.
         * The "migration-threshold" nvpairs outside of resource and
           rsc_defaults meta_attributes blocks should be unchanged. This
           includes the nvpair in an op meta_attributes block.
         * If an "migration-threshold" nvpair with value != "default" is
           preceded by an nvpair with the same name and value = "default" in an
           earlier block:
           * If the earlier block has no rule, the non-default nvpair should be
             dropped, since it could never be applied.
           * Otherwise, the non-default nvpair should be moved to a new
             meta_attributes block with the same score as its current one, with
             a compound "and" rule. The compound rule should reference the
             existing rule and the negations of the rules in the earlier blocks.
         * The nvpair with name != "migration-threshold" should be unchanged.

         This test is not exhaustive but covers a fair number of permutations.
         The main purpose is to ensure this transformation affects all the
         correct elements ("migration-threshold" nvpairs within resource and
         rsc_defaults meta_attributes blocks) and ONLY those.
      -->
    <crm_config>
      <cluster_property_set id="cib-bootstrap-options">
        <nvpair id="cib-bootstrap-options-migration-threshold" name="migration-threshold" value="default"/>
      </cluster_property_set>
    </crm_config>
    <nodes/>
    <resources>
      <template class="ocf" id="template1" provider="pacemaker" type="Dummy">
        <meta_attributes id="template1-meta_attributes">
          <nvpair id="template1-meta_attributes-migration-threshold" name="migration-threshold" value="default"/>
          <nvpair id="template1-meta_attributes-some-option" name="some-option" value="default"/>
        </meta_attributes>
      </template>
      <primitive class="ocf" id="rsc1" provider="pacemaker" type="Dummy">
        <operations>
          <op id="rsc1_monitor_20000" interval="20s" name="monitor">
            <meta_attributes id="rsc1_monitor_20000-meta_attributes">
              <nvpair id="rsc1_monitor_20000-meta_attributes-migration-threshold" name="migration-threshold" value="default"/>
            </meta_attributes>
          </op>
        </operations>
        <!-- 10, default, 10, 10, default -->
        <instance_attributes id="rsc1-instance_attributes">
          <nvpair id="rsc1-instance_attributes-migration-threshold" name="migration-threshold" value="default"/>
        </instance_attributes>
        <utilization id="rsc1-utilization">
          <nvpair id="rsc1-utilization-migration-threshold" name="migration-threshold" value="default"/>
        </utilization>
        <meta_attributes id="rsc1-meta_attributes1">
          <rule id="rsc1-meta_attributes1-rule">
            <date_expression id="rsc1-meta_attributes1-rule-expr" operation="in_range" start="2004-001"/>
          </rule>
          <nvpair id="rsc1-meta_attributes1-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="rsc1-meta_attributes2">
          <rule id="rsc1-meta_attributes2-rule">
            <date_expression id="rsc1-meta_attributes2-rule-expr" operation="in_range" start="2004-001"/>
          </rule>
          <nvpair id="rsc1-meta_attributes2-migration-threshold" name="migration-threshold" value="default"/>
        </meta_attributes>
        <meta_attributes id="rsc1-meta_attributes3">
          <rule id="rsc1-meta_attributes3-rule">
            <date_expression id="rsc1-meta_attributes3-rule-expr" operation="in_range" start="2004-001"/>
          </rule>
          <nvpair id="rsc1-meta_attributes3-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="rsc1-meta_attributes4">
          <rule id="rsc1-meta_attributes4-rule">
            <date_expression id="rsc1-meta_attributes4-rule-expr" operation="in_range" start="2004-001"/>
          </rule>
          <nvpair id="rsc1-meta_attributes4-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="rsc1-meta_attributes5">
          <rule id="rsc1-meta_attributes5-rule">
            <date_expression id="rsc1-meta_attributes5-rule-expr" operation="in_range" start="2004-001"/>
          </rule>
          <nvpair id="rsc1-meta_attributes5-migration-threshold" name="migration-threshold" value="default"/>
        </meta_attributes>
      </primitive>
      <group id="grp1">
        <primitive class="ocf" id="rsc2" provider="pacemaker" type="Dummy">
          <!-- 10, default, 10, 10, default -->
          <meta_attributes id="rsc2-meta_attributes1">
            <rule id-ref="rsc1-meta_attributes1-rule"/>
            <nvpair id="rsc2-meta_attributes1-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="rsc2-meta_attributes2">
            <!-- No rule for first "default" nvpair -->
            <nvpair id="rsc2-meta_attributes2-migration-threshold" name="migration-threshold" value="default"/>
          </meta_attributes>
          <meta_attributes id="rsc2-meta_attributes3">
            <rule id-ref="rsc1-meta_attributes3-rule"/>
            <nvpair id="rsc2-meta_attributes3-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="rsc2-meta_attributes4">
            <rule id-ref="rsc1-meta_attributes4-rule"/>
            <nvpair id="rsc2-meta_attributes4-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="rsc2-meta_attributes5">
            <rule id-ref="rsc1-meta_attributes5-rule"/>
            <nvpair id="rsc2-meta_attributes5-migration-threshold" name="migration-threshold" value="default"/>
          </meta_attributes>
        </primitive>
        <!-- 10, default, 10, 10, default -->
        <meta_attributes id="grp1-meta_attributes1">
          <rule id-ref="rsc1-meta_attributes1-rule"/>
          <nvpair id="grp1-meta_attributes1-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="grp1-meta_attributes2">
          <!-- No rule for first "default" nvpair -->
          <nvpair id="grp1-meta_attributes2-migration-threshold" name="migration-threshold" value="default"/>
        </meta_attributes>
        <meta_attributes id="grp1-meta_attributes3">
          <!-- No rule for first non-"default" nvpair after first "default" -->
          <nvpair id="grp1-meta_attributes3-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="grp1-meta_attributes4">
          <rule id-ref="rsc1-meta_attributes4-rule"/>
          <nvpair id="grp1-meta_attributes4-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="grp1-meta_attributes5">
          <rule id-ref="rsc1-meta_attributes5-rule"/>
          <nvpair id="grp1-meta_attributes5-migration-threshold" name="migration-threshold" value="default"/>
        </meta_attributes>
      </group>
      <clone id="clone1">
        <primitive class="ocf" id="rsc3" provider="pacemaker" type="Dummy">
          <!-- 10, default, 10, 10, default -->
          <meta_attributes id="rsc3-meta_attributes1">
            <rule id-ref="rsc1-meta_attributes1-rule"/>
            <nvpair id="rsc3-meta_attributes1-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="rsc3-meta_attributes2">
            <rule id-ref="rsc1-meta_attributes2-rule"/>
            <nvpair id="rsc3-meta_attributes2-migration-threshold" name="migration-threshold" value="default"/>
          </meta_attributes>
          <meta_attributes id="rsc3-meta_attributes3">
            <rule id-ref="rsc1-meta_attributes3-rule"/>
            <nvpair id="rsc3-meta_attributes3-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="rsc3-meta_attributes4">
            <rule id-ref="rsc1-meta_attributes4-rule"/>
            <nvpair id="rsc3-meta_attributes4-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="rsc3-meta_attributes5">
            <!-- No rule for last "default" nvpair -->
            <nvpair id="rsc3-meta_attributes5-migration-threshold" name="migration-threshold" value="default"/>
          </meta_attributes>
        </primitive>
        <!-- 10, default, 10, 10, default -->
        <!-- No rule for any block -->
        <meta_attributes id="clone1-meta_attributes1">
          <nvpair id="clone1-meta_attributes1-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="clone1-meta_attributes2">
          <nvpair id="clone1-meta_attributes2-migration-threshold" name="migration-threshold" value="default"/>
        </meta_attributes>
        <meta_attributes id="clone1-meta_attributes3">
          <nvpair id="clone1-meta_attributes3-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="clone1-meta_attributes4">
          <nvpair id="clone1-meta_attributes4-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="clone1-meta_attributes5">
          <nvpair id="clone1-meta_attributes5-migration-threshold" name="migration-threshold" value="default"/>
        </meta_attributes>
      </clone>
      <clone id="clone2">
        <group id="grp2">
          <primitive class="ocf" id="rsc4" provider="pacemaker" type="Dummy">
            <!-- 10, 10, 10, default, default -->
            <meta_attributes id="rsc4-meta_attributes1">
              <rule id-ref="rsc1-meta_attributes1-rule"/>
              <nvpair id="rsc4-meta_attributes1-migration-threshold" name="migration-threshold" value="10"/>
            </meta_attributes>
            <meta_attributes id="rsc4-meta_attributes2">
              <rule id-ref="rsc1-meta_attributes2-rule"/>
              <nvpair id="rsc4-meta_attributes2-migration-threshold" name="migration-threshold" value="10"/>
            </meta_attributes>
            <meta_attributes id="rsc4-meta_attributes3">
              <rule id-ref="rsc1-meta_attributes3-rule"/>
              <nvpair id="rsc4-meta_attributes3-migration-threshold" name="migration-threshold" value="10"/>
            </meta_attributes>
            <meta_attributes id="rsc4-meta_attributes4">
              <rule id-ref="rsc1-meta_attributes4-rule"/>
              <nvpair id="rsc4-meta_attributes4-migration-threshold" name="migration-threshold" value="default"/>
            </meta_attributes>
            <meta_attributes id="rsc4-meta_attributes5">
              <rule id-ref="rsc1-meta_attributes5-rule"/>
              <nvpair id="rsc4-meta_attributes5-migration-threshold" name="migration-threshold" value="default"/>
            </meta_attributes>
          </primitive>
          <!-- default, default, 10, 10, 10 -->
          <meta_attributes id="grp2-meta_attributes1">
            <rule id-ref="rsc1-meta_attributes1-rule"/>
            <nvpair id="grp2-meta_attributes1-migration-threshold" name="migration-threshold" value="default"/>
          </meta_attributes>
          <meta_attributes id="grp2-meta_attributes2">
            <rule id-ref="rsc1-meta_attributes2-rule"/>
            <nvpair id="grp2-meta_attributes2-migration-threshold" name="migration-threshold" value="default"/>
          </meta_attributes>
          <meta_attributes id="grp2-meta_attributes3">
            <rule id-ref="rsc1-meta_attributes3-rule"/>
            <nvpair id="grp2-meta_attributes3-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="grp2-meta_attributes4">
            <rule id-ref="rsc1-meta_attributes4-rule"/>
            <nvpair id="grp2-meta_attributes4-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="grp2-meta_attributes5">
            <rule id-ref="rsc1-meta_attributes5-rule"/>
            <nvpair id="grp2-meta_attributes5-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
        </group>
        <!-- default, 10, default, 10, 10 -->
        <meta_attributes id="clone2-meta_attributes1">
          <rule id-ref="rsc1-meta_attributes1-rule"/>
          <nvpair id="clone2-meta_attributes1-migration-threshold" name="migration-threshold" value="default"/>
        </meta_attributes>
        <meta_attributes id="clone2-meta_attributes2">
          <rule id-ref="rsc1-meta_attributes2-rule"/>
          <nvpair id="clone2-meta_attributes2-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="clone2-meta_attributes3">
          <rule id-ref="rsc1-meta_attributes3-rule"/>
          <nvpair id="clone2-meta_attributes3-migration-threshold" name="migration-threshold" value="default"/>
        </meta_attributes>
        <meta_attributes id="clone2-meta_attributes4">
          <rule id-ref="rsc1-meta_attributes4-rule"/>
          <nvpair id="clone2-meta_attributes4-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
        <meta_attributes id="clone2-meta_attributes5">
          <rule id-ref="rsc1-meta_attributes5-rule"/>
          <nvpair id="clone2-meta_attributes5-migration-threshold" name="migration-threshold" value="10"/>
        </meta_attributes>
      </clone>
      <bundle id="bundle1">
        <podman image="localhost/pcmktest:http" replicas="3"/>
        <primitive class="ocf" id="rsc5" provider="heartbeat" type="apache">
          <!-- default, 10, 10, default, 10 -->
          <meta_attributes id="rsc5-meta_attributes1">
            <rule id-ref="rsc1-meta_attributes1-rule"/>
            <nvpair id="rsc5-meta_attributes1-migration-threshold" name="migration-threshold" value="default"/>
          </meta_attributes>
          <meta_attributes id="rsc5-meta_attributes2">
            <rule id-ref="rsc1-meta_attributes2-rule"/>
            <nvpair id="rsc5-meta_attributes2-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="rsc5-meta_attributes3">
            <rule id-ref="rsc1-meta_attributes3-rule"/>
            <nvpair id="rsc5-meta_attributes3-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
          <meta_attributes id="rsc5-meta_attributes4">
            <rule id-ref="rsc1-meta_attributes4-rule"/>
            <nvpair id="rsc5-meta_attributes4-migration-threshold" name="migration-threshold" value="default"/>
          </meta_attributes>
          <meta_attributes id="rsc5-meta_attributes5">
            <rule id-ref="rsc1-meta_attributes5-rule"/>
            <nvpair id="rsc5-meta_attributes5-migration-threshold" name="migration-threshold" value="10"/>
          </meta_attributes>
        </primitive>
        <meta_attributes id="bundle1-meta_attributes">
          <nvpair id="bundle1-meta_attributes-migration-threshold" name="migration-threshold" value="default"/>
        </meta_attributes>
      </bundle>
    </resources>
    <constraints/>
    <rsc_defaults>
      <!-- default, 10, 10, 10, default -->
      <meta_attributes id="rsc_defaults-meta_attributes1">
        <rule id-ref="rsc1-meta_attributes1-rule"/>
        <nvpair id="rsc_defaults-meta_attributes1-migration-threshold" name="migration-threshold" value="default"/>
      </meta_attributes>
      <meta_attributes id="rsc_defaults-meta_attributes2">
        <rule id-ref="rsc1-meta_attributes2-rule"/>
        <nvpair id="rsc_defaults-meta_attributes2-migration-threshold" name="migration-threshold" value="10"/>
      </meta_attributes>
      <meta_attributes id="rsc_defaults-meta_attributes3">
        <rule id-ref="rsc1-meta_attributes3-rule"/>
        <nvpair id="rsc_defaults-meta_attributes3-migration-threshold" name="migration-threshold" value="10"/>
      </meta_attributes>
      <meta_attributes id="rsc_defaults-meta_attributes4">
        <rule id-ref="rsc1-meta_attributes4-rule"/>
        <nvpair id="rsc_defaults-meta_attributes4-migration-threshold" name="migration-threshold" value="10"/>
      </meta_attributes>
      <meta_attributes id="rsc_defaults-meta_attributes5">
        <rule id-ref="rsc1-meta_attributes5-rule"/>
        <nvpair id="rsc_defaults-meta_attributes5-migration-threshold" name="migration-threshold" value="default"/>
      </meta_attributes>
    </rsc_defaults>
  </configuration>
  <status/>
</cib>
